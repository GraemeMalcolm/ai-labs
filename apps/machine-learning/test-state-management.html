<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Management Test - ML Lite</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .pass { color: green; }
        .fail { color: red; }
        button { margin: 5px; padding: 8px 12px; }
    </style>
</head>
<body>
    <h1>ML Lite State Management Test</h1>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
        <button onclick="runTests()">Run Tests</button>
    </div>
    
    <div class="test-section">
        <h2>Manual Testing Steps</h2>
        <ol>
            <li>Open the main ML Lite app</li>
            <li>Upload a CSV file with headers</li>
            <li>Select a model type and configure training settings</li>
            <li>Train the model</li>
            <li>Go back to Training Settings tab</li>
            <li>Change any setting (target column, features, train split, etc.)</li>
            <li>Verify that a warning message appears indicating settings changed</li>
            <li>Go to Training Process tab</li>
            <li>Verify that a "Retrain Model" button appears instead of "Start Training"</li>
            <li>Click "Retrain Model" to train with new settings</li>
            <li>Verify that the warning disappears after successful training</li>
            <li>Navigate between tabs and verify state is preserved</li>
            <li>Click "Train Another Model" to reset completely</li>
        </ol>
    </div>

    <script src="script.js"></script>
    <script>
        // Simple unit tests for state management functions
        function runTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '';
            
            const tests = [
                testGetCurrentTrainingSettings,
                testHasTrainingSettingsChanged,
                testSaveCurrentTrainingSettings,
                testMarkSettingsChanged
            ];
            
            let passed = 0;
            let total = tests.length;
            
            tests.forEach(test => {
                try {
                    const result = test();
                    results.innerHTML += `<div class="${result ? 'pass' : 'fail'}">${test.name}: ${result ? 'PASS' : 'FAIL'}</div>`;
                    if (result) passed++;
                } catch (error) {
                    results.innerHTML += `<div class="fail">${test.name}: ERROR - ${error.message}</div>`;
                }
            });
            
            results.innerHTML += `<div><strong>Results: ${passed}/${total} tests passed</strong></div>`;
        }
        
        function testGetCurrentTrainingSettings() {
            // Test that getCurrentTrainingSettings returns expected structure
            appState.modelType = 'regression';
            appState.targetColumn = 'price';
            appState.featureColumns = ['feature1', 'feature2'];
            
            const settings = getCurrentTrainingSettings();
            
            return settings.modelType === 'regression' &&
                   settings.targetColumn === 'price' &&
                   Array.isArray(settings.featureColumns) &&
                   settings.featureColumns.length === 2;
        }
        
        function testHasTrainingSettingsChanged() {
            // Test change detection
            appState.lastTrainingSettings = null;
            let changed = hasTrainingSettingsChanged();
            if (changed !== false) return false; // Should be false when no baseline
            
            // Set baseline
            saveCurrentTrainingSettings();
            changed = hasTrainingSettingsChanged();
            if (changed !== false) return false; // Should be false when same
            
            // Change something
            appState.modelType = 'classification';
            changed = hasTrainingSettingsChanged();
            return changed === true; // Should be true when different
        }
        
        function testSaveCurrentTrainingSettings() {
            // Test that saving settings works
            appState.modelType = 'clustering';
            saveCurrentTrainingSettings();
            
            return appState.lastTrainingSettings &&
                   appState.lastTrainingSettings.modelType === 'clustering' &&
                   appState.hasUnsavedChanges === false;
        }
        
        function testMarkSettingsChanged() {
            // Test that marking changes works when model exists
            appState.trainedModel = { type: 'regression' };
            appState.lastTrainingSettings = { modelType: 'regression' };
            appState.modelType = 'classification';
            
            markSettingsChanged();
            
            return appState.hasUnsavedChanges === true;
        }
        
        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 100);
        });
    </script>
</body>
</html>